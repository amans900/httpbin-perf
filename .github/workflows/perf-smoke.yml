name: perf-smoke

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  jmeter-smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start minimal infra (httpbin + monitoring)
        run: |
          set -eux
          docker compose up -d influxdb httpbin grafana loki promtail prometheus cadvisor
          sleep 15
          docker ps

      - name: Build JMeter image (5.6.3)
        run: docker build -t jmeter:5.6.3 ./jmeter/docker

      - name: Run smoke test (headless; write JTL + jmeter.log)
        run: |
          set -euxo pipefail
          rm -rf jmeter/results/smoke jmeter/results/smoke.jtl || true
          mkdir -p jmeter/results/smoke/html

          # Run JMeter completely headless (no AWT) and force CSV header + standard columns
          docker run --rm --network host \
            -e JVM_ARGS="-Djava.awt.headless=true -Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m" \
            -v "$GITHUB_WORKSPACE/jmeter:/jmeter" -w /jmeter jmeter:5.6.3 \
            -q config/user.properties \
            -Jjmeter.save.saveservice.output_format=csv \
            -Jjmeter.save.saveservice.print_field_names=true \
            -Jjmeter.save.saveservice.default_delimiter=, \
            -Jjmeter.save.saveservice.timestamp_format=ms \
            -Jjmeter.save.saveservice.data_type=true \
            -Jjmeter.save.saveservice.label=true \
            -Jjmeter.save.saveservice.response_code=true \
            -Jjmeter.save.saveservice.response_message=true \
            -Jjmeter.save.saveservice.thread_name=true \
            -Jjmeter.save.saveservice.successful=true \
            -Jjmeter.save.saveservice.failure_message=true \
            -Jjmeter.save.saveservice.bytes=true \
            -Jjmeter.save.saveservice.sent_bytes=true \
            -Jjmeter.save.saveservice.grp_threads=true \
            -Jjmeter.save.saveservice.all_threads=true \
            -Jjmeter.save.saveservice.URL=true \
            -Jjmeter.save.saveservice.latency=true \
            -Jjmeter.save.saveservice.idle_time=true \
            -Jjmeter.save.saveservice.connect_time=true \
            -n -t testplans/httpbin_load.jmx \
            -Jthreads=50 -Jrampup=30 -Jduration=60 \
            -Jtarget_host=localhost -Jtarget_port=8080 \
            -l results/smoke.jtl \
            -j results/smoke/jmeter.log

          # Prove the JTL has a header (visible in logs)
          head -n 2 jmeter/results/smoke.jtl || true

      - name: Generate HTML report (headless)
        run: |
          set -eux
          docker run --rm --network host \
            -e JVM_ARGS="-Djava.awt.headless=true -Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m" \
            -v "$GITHUB_WORKSPACE/jmeter:/jmeter" -w /jmeter jmeter:5.6.3 \
            -g results/smoke.jtl -o results/smoke/html
          ls -R jmeter/results/smoke

      - name: Upload JMeter artifacts (HTML + JTL + jmeter.log)
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-smoke-artifacts
          if-no-files-found: error
          path: |
            jmeter/results/smoke/html
            jmeter/results/smoke.jtl
            jmeter/results/smoke/jmeter.log

      - name: Stop stack
        if: always()
        run: docker compose down -v
